<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>To-Do List con Firestore</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col">

  <header class="bg-blue-600 text-white py-6 text-center">
    <h1 class="text-3xl font-bold">Pedidos 📦</h1>
  </header>

  <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
    <form id="task-form" class="flex flex-col sm:flex-row gap-4 mb-6" style="display: none;">
      <textarea
        id="task-input"
        placeholder="Escribe una tarea..."
        required
        class="flex-1 p-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y"
        rows="2"
      ></textarea>
      <button
        type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded transition self-start"
      >
        Agregar
      </button>
    </form>

    <ul id="task-list" class="space-y-6">
      <!-- Tareas se cargan aquí -->
    </ul>

    <div id="auth-buttons" class="flex justify-center space-x-4 mt-6">
      <button id="login-btn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded">Iniciar sesión</button>
      <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded" style="display: none;">Cerrar sesión</button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC26tExI2Qzm_dczDvGRx58M_9b4qD3Ajw",
      authDomain: "tareas-d2893.firebaseapp.com",
      projectId: "tareas-d2893",
      storageBucket: "tareas-d2893.firebasestorage.app",
      messagingSenderId: "930777625775",
      appId: "1:930777625775:web:347b4c3814d99d163ad05a",
      measurementId: "G-N1WRTWBEBM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const tareasRef = collection(db, "tareas");

    const taskForm = document.getElementById("task-form");
    const taskInput = document.getElementById("task-input");
    const taskList = document.getElementById("task-list");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");

    // Manejar el estado de la autenticación
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Usuario autenticado
        taskForm.style.display = "flex";  // Mostrar el formulario para agregar tareas
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        // Usuario no autenticado
        taskForm.style.display = "none";  // Ocultar el formulario para agregar tareas
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    });

    // Iniciar sesión anónimamente
    loginBtn.addEventListener("click", () => {
      signInAnonymously(auth).catch((error) => {
        console.error("Error al iniciar sesión:", error);
        });
    });

    // Cerrar sesión
    logoutBtn.addEventListener("click", () => {
      signOut(auth).catch((error) => {
        console.error("Error al cerrar sesión:", error);
      });
    });

    // Enviar tarea a Firestore
    taskForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = taskInput.value.trim();
      if (text !== "") {
        await addDoc(tareasRef, { text, status: "Pendiente" });
        taskInput.value = "";
        taskInput.focus();
      }
    });

    // Escuchar cambios en tiempo real
    onSnapshot(tareasRef, (snapshot) => {
      taskList.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        renderTask(docSnap.id, data.text, data.status);
      });
    });

    // Renderizar tarea
function renderTask(id, text, status = "Pendiente") {
  const li = document.createElement("li");
  li.className = "bg-white p-4 rounded shadow space-y-4";

  const top = document.createElement("div");
  top.className = "flex flex-col sm:flex-row justify-between items-center gap-4";

  const span = document.createElement("span");
  span.innerHTML = (text || "").replace(/\n/g, "<br>"); // Aquí es donde aplicas la corrección
  span.className = "flex-1 font-semibold cursor-pointer";

  span.addEventListener("click", () => {
    span.classList.toggle("line-through");
    span.classList.toggle("text-gray-400");
  });

  const select = document.createElement("select");
  select.className = "p-2 rounded border border-gray-300 focus:outline-none";
  const estados = ["Pendiente", "Haciendo", "Pausado", "Terminado", "Enviado"];
  estados.forEach((estado) => {
    const opt = document.createElement("option");
    opt.value = estado;
    opt.textContent = estado;
    select.appendChild(opt);
  });
  select.value = status;

  select.addEventListener("change", async () => {
    await updateDoc(doc(db, "tareas", id), { status: select.value });
  });

  const borrar = document.createElement("button");
  borrar.textContent = "Borrar";
  borrar.className = "bg-red-500 hover:bg-red-600 text-white p-2 rounded transition";
  borrar.addEventListener("click", async () => {
    await deleteDoc(doc(db, "tareas", id));
  });

  const progressContainer = document.createElement("div");
  progressContainer.className = "w-full h-4 bg-gray-200 rounded overflow-hidden";

  const progressBar = document.createElement("div");
  progressBar.className = "h-full transition-all duration-500";
  progressContainer.appendChild(progressBar);

  updateProgress(progressBar, status);

  select.addEventListener("change", () => {
    updateProgress(progressBar, select.value);
  });

  top.appendChild(span);
  top.appendChild(select);
  top.appendChild(borrar);

  li.appendChild(top);
  li.appendChild(progressContainer);
  taskList.appendChild(li);
}


    function updateProgress(bar, estado) {
      const estilos = {
        Pendiente: "w-[10%] bg-gray-400",
        Haciendo: "w-[50%] bg-blue-500",
        Pausado: "w-[50%] bg-yellow-400",
        Terminado: "w-[100%] bg-green-500",
        Enviado: "w-[100%] bg-purple-500"
      };
      bar.className = `h-full transition-all duration-500 ${estilos[estado] || "w-[10%] bg-gray-400"}`;
    }
  </script>
</body>
</html>
